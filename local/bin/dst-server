#!/usr/bin/env fish
# Per-shard runner â€” starts a single DST server shard.
# Usage: dst-server <ShardName>

if test (count $argv) -ne 1
    echo "Usage: (status filename) <ShardName>" >&2
    exit 2
end
set -l SHARD $argv[1]

set -l CONFIG_FILE "$HOME/.config/dontstarve/config"
if test -f "$CONFIG_FILE"
    # Emulation of reading simple environment variables from a file (Key=Value)
    for line in (cat $CONFIG_FILE | string match -r '^[^#].*=.*')
        set -l parts (string split -m 1 "=" $line)
        set -l key (string trim $parts[1])
        set -l value (string trim -c '"' $parts[2] | string replace -r '^\$HOME' "$HOME" | string replace -r '^~' "$HOME")
        set -gx $key $value
    end
end

# Default values (only set if not already in environment)
set -q STEAMCMD_DIR; or set -gx STEAMCMD_DIR "$HOME/steamcmd"
set -q INSTALL_DIR; or set -gx INSTALL_DIR "$HOME/dontstarvetogether_dedicated_server"
set -q CLUSTER_NAME; or set -gx CLUSTER_NAME MyDediServer
set -q DONTSTARVE_DIR; or set -gx DONTSTARVE_DIR "$HOME/.klei/DoNotStarveTogether"
set -q DONTSTARVE_BETA_DIR; or set -gx DONTSTARVE_BETA_DIR "$HOME/.klei/DoNotStarveTogetherBetaBranch"

# Handle beta branch - use beta saves directory
if test "$BRANCH" = "beta"
    set -gx DONTSTARVE_DIR "$DONTSTARVE_BETA_DIR"
end

function fail
    echo "Error: $argv" >&2
    exit 1
end

# Verification of cluster files
test -f "$DONTSTARVE_DIR/$CLUSTER_NAME/cluster.ini"; or fail "Missing file: $DONTSTARVE_DIR/$CLUSTER_NAME/cluster.ini"
test -f "$DONTSTARVE_DIR/$CLUSTER_NAME/cluster_token.txt"; or fail "Missing file: $DONTSTARVE_DIR/$CLUSTER_NAME/cluster_token.txt"
test -d "$DONTSTARVE_DIR/$CLUSTER_NAME/$SHARD"; or fail "Missing directory: $DONTSTARVE_DIR/$CLUSTER_NAME/$SHARD"
test -f "$DONTSTARVE_DIR/$CLUSTER_NAME/$SHARD/server.ini"; or fail "Missing file: $DONTSTARVE_DIR/$CLUSTER_NAME/$SHARD/server.ini"

# Prevent multiple instances
if test -f /tmp/dst-server-"$SHARD".pid
    if kill -0 (cat /tmp/dst-server-"$SHARD".pid) 2>/dev/null
        fail "Server for shard $SHARD is already running (PID: "(cat /tmp/dst-server-"$SHARD".pid)")"
    end
    rm -f /tmp/dst-server-"$SHARD".pid
end
echo $fish_pid > /tmp/dst-server-"$SHARD".pid

# Find binary directory
set -l BIN_DIR ""
if test -d "$INSTALL_DIR/bin64"
    set BIN_DIR "$INSTALL_DIR/bin64"
else if test -d "$INSTALL_DIR/bin"
    set BIN_DIR "$INSTALL_DIR/bin"
else
    fail "Cannot find server binary directory inside $INSTALL_DIR (expected bin64 or bin)"
end

cd $BIN_DIR; or fail "Cannot cd to $BIN_DIR"

set -l SERVER_BIN ""
if test -x "./dontstarve_dedicated_server_nullrenderer_x64"
    set SERVER_BIN "./dontstarve_dedicated_server_nullrenderer_x64"
else if test -x "./dontstarve_dedicated_server_nullrenderer"
    set SERVER_BIN "./dontstarve_dedicated_server_nullrenderer"
else
    fail "Server binary not found or not executable in $BIN_DIR"
end

echo "Starting DST shard='$SHARD' cluster='$CLUSTER_NAME' (binary: $SERVER_BIN)"
# exec replaces the shell process with the server process
exec $SERVER_BIN -console -cluster "$CLUSTER_NAME" -shard "$SHARD"
